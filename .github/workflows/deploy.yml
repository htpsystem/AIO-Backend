name: Deploy AIO Backend (Docker Hub + VPS)

on:
  push:
    branches: [ "main" ]       # Deploy only when pushing to main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # STEP 1 â€” Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # STEP 2 â€” Log in to Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}   # you already created this
          password: ${{ secrets.DOCKER_PASSWORD }}      # token from Docker Hub

      # STEP 3 â€” Build Docker image
      - name: Build Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/aio-backend:latest .

      # STEP 4 â€” Push Docker image to Docker Hub
      - name: Push Docker image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/aio-backend:latest

      # STEP 5 â€” Deploy on VPS using SSH
      - name: Deploy on VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_SERVER_IP }}         # your VPS IP
          username: ${{ secrets.VPS_SERVER_USER }}   # usually root
          key: ${{ secrets.VPS_SSH }}            # your private SSH key
          port: 22

          script: |
            echo "ðŸš€ Connected to VPS"

            cd ${{ secrets.REMOTE_DOCKER_COMPOSE_DIR }}

            # Stop old container
            docker stop aio-backend || true
            docker rm aio-backend || true

            # Pull latest image from Docker Hub
            # docker pull ${{ secrets.DOCKER_USERNAME }}/aio-backend:latest

            # # Run new backend container
            # docker run -d \
            #   --name aio-backend \
            #   -p 8080:8080 \
            #   ${{ secrets.DOCKER_USERNAME }}/aio-backend:latest

            echo "Pulling latest image from docker hub"
            docker compose pull
            docker compose up -d --remove-orphans

            echo "ðŸŽ‰ Deployment completed successfully!"
